<!DOCTYPE html>
<html>
<head>
    <title>Dad's Translator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #222; color: white; }
        button { padding: 20px 40px; font-size: 20px; border-radius: 50px; border: none; cursor: pointer; margin-top: 50px; }
        .start { background-color: #4CAF50; color: white; }
        .stop { background-color: #f44336; color: white; display: none; }
        #status { margin-top: 20px; font-size: 18px; color: #aaa; }
    </style>
</head>
<body>
    <h1>üá®üá≥ Dad's Translator</h1>
    <p>Put phone next to speaker</p>

    <button id="startBtn" class="start" onclick="startTranslation()">Start Listening</button>
    <button id="stopBtn" class="stop" onclick="stopTranslation()">Stop</button>
    
    <div id="status">Ready</div>

    <script>
        let socket;
        let mediaRecorder;
        
        async function startTranslation() {
            // Check if we're in a secure context (HTTPS required for microphone on mobile)
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                document.getElementById('status').innerText = "‚ùå HTTPS required for microphone access. See instructions below.";
                document.getElementById('status').style.color = "#f44336";
                return;
            }
            
            document.getElementById('status').innerText = "Connecting...";
            
            try {
                // 1. Request Microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. Open WebSocket to your computer
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                socket = new WebSocket(`${protocol}//${window.location.host}/ws`);

                socket.onopen = () => {
                    document.getElementById('status').innerText = "üî¥ Listening...";
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    
                    // 3. Start Recording & Sending
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.addEventListener('dataavailable', async event => {
                        if (event.data.size > 0 && socket.readyState === 1) {
                            socket.send(event.data);
                        }
                    });
                    mediaRecorder.start(250); // Send chunk every 250ms
                };

                // 4. Play incoming Audio (The Chinese Translation)
                // Buffer incoming audio chunks and play them
                let audioQueue = [];
                let isPlaying = false;
                
                async function playNextAudio() {
                    if (audioQueue.length === 0) {
                        isPlaying = false;
                        return;
                    }
                    isPlaying = true;
                    const audioBlob = audioQueue.shift();
                    const audioUrl = URL.createObjectURL(new Blob([audioBlob], { type: 'audio/mpeg' }));
                    const audio = new Audio(audioUrl);
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        playNextAudio();
                    };
                    audio.onerror = () => {
                        console.error('Audio playback error');
                        playNextAudio();
                    };
                    try {
                        await audio.play();
                    } catch (e) {
                        console.error('Play failed:', e);
                        playNextAudio();
                    }
                }
                
                socket.onmessage = async (event) => {
                    audioQueue.push(event.data);
                    if (!isPlaying) {
                        playNextAudio();
                    }
                };
                
                socket.onclose = () => {
                    resetUI();
                };
                
                socket.onerror = (error) => {
                    document.getElementById('status').innerText = "‚ùå WebSocket Error";
                    console.error("WebSocket error:", error);
                    resetUI();
                };
            } catch (error) {
                document.getElementById('status').innerText = "‚ùå " + error.message;
                document.getElementById('status').style.color = "#f44336";
                console.error("Error:", error);
            }
        }

        function stopTranslation() {
            if (mediaRecorder) mediaRecorder.stop();
            if (socket) socket.close();
            resetUI();
        }

        function resetUI() {
            document.getElementById('status').innerText = "Stopped";
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
        }
    </script>
</body>
</html>