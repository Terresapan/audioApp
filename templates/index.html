<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>çˆ¸çˆ¸çš„ç¿»è¯‘å™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #222; color: white; }
        button { padding: 20px 40px; font-size: 20px; border-radius: 50px; border: none; cursor: pointer; margin-top: 50px; }
        .start { background-color: #4CAF50; color: white; }
        .stop { background-color: #f44336; color: white; display: none; }
        .clear { background-color: #555; color: white; padding: 15px 30px; font-size: 18px; display: block; margin: 30px auto; }
        #status { margin-top: 20px; font-size: 18px; color: #aaa; }
    </style>
</head>
<body>
    <h1>ğŸ‡¨ğŸ‡³ çˆ¸çˆ¸çš„ç¿»è¯‘å™¨ ğŸ‡ºğŸ‡¸</h1>
    <p>æŠŠæ‰‹æœºæ”¾åœ¨æ‰¬å£°å™¨æ—è¾¹</p>

    <button id="startBtn" class="start" onclick="startTranslation()">å¼€å§‹æ”¶å¬</button>
    <button id="stopBtn" class="stop" onclick="stopTranslation()">åœæ­¢</button>
    <button id="clearBtn" class="clear" onclick="clearTranslation()">ğŸ—‘ï¸ æ¸…é™¤ç¿»è¯‘</button>
    
    <div id="translationText" style="margin: 30px 20px; font-size: 24px; font-weight: bold; min-height: 50px;"></div>
    
    <div id="status">å‡†å¤‡å°±ç»ª</div>

    <script>
        let socket;
        let mediaRecorder;
        
        async function startTranslation() {
            // Check if we're in a secure context (HTTPS required for microphone on mobile)
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                document.getElementById('status').innerText = "âŒ éœ€è¦HTTPSæ‰èƒ½ä½¿ç”¨éº¦å…‹é£";
                document.getElementById('status').style.color = "#f44336";
                return;
            }
            
            document.getElementById('status').innerText = "è¿æ¥ä¸­...";
            
            try {
                // 1. Request Microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. Open WebSocket to your computer
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                socket = new WebSocket(`${protocol}//${window.location.host}/ws/audio`);

                socket.onopen = () => {
                    document.getElementById('status').innerText = "ğŸ”´ æ­£åœ¨æ”¶å¬...";
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    
                    // 3. Start Recording & Sending
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.addEventListener('dataavailable', async event => {
                        if (event.data.size > 0 && socket.readyState === 1) {
                            socket.send(event.data);
                        }
                    });
                    mediaRecorder.start(250); // Send chunk every 250ms
                };

                // 4. Play incoming Audio (The Chinese Translation)
                // Buffer incoming audio chunks and play them
                let audioQueue = [];
                let isPlaying = false;
                
                async function playNextAudio() {
                    if (audioQueue.length === 0) {
                        isPlaying = false;
                        return;
                    }
                    isPlaying = true;
                    const audioBlob = audioQueue.shift();
                    const audioUrl = URL.createObjectURL(new Blob([audioBlob], { type: 'audio/mpeg' }));
                    const audio = new Audio(audioUrl);
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        playNextAudio();
                    };
                    audio.onerror = () => {
                        console.error('Audio playback error');
                        playNextAudio();
                    };
                    try {
                        await audio.play();
                    } catch (e) {
                        console.error('Play failed:', e);
                        playNextAudio();
                    }
                }
                
                socket.onmessage = async (event) => {
                    if (typeof event.data === "string") {
                        try {
                            const msg = JSON.parse(event.data);
                            if (msg.type === 'translation') {
                                document.getElementById('translationText').innerText = msg.translation;
                            } else if (msg.type === 'status') {
                                document.getElementById('status').innerText = msg.message;
                            }
                        } catch (e) {
                            console.error("Error parsing message:", e);
                        }
                    } else {
                        // Binary data is audio
                        audioQueue.push(event.data);
                        if (!isPlaying) {
                            playNextAudio();
                        }
                    }
                };
                
                socket.onclose = () => {
                    resetUI();
                };
                
                socket.onerror = (error) => {
                    document.getElementById('status').innerText = "âŒ WebSocket é”™è¯¯";
                    console.error("WebSocket error:", error);
                    resetUI();
                };
            } catch (error) {
                document.getElementById('status').innerText = "âŒ " + error.message;
                document.getElementById('status').style.color = "#f44336";
                console.error("Error:", error);
            }
        }

        function stopTranslation() {
            if (mediaRecorder) mediaRecorder.stop();
            if (socket) socket.close();
            resetUI();
        }

        function clearTranslation() {
            document.getElementById('translationText').innerText = "";
        }

        function resetUI() {
            document.getElementById('status').innerText = "å·²åœæ­¢";
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
        }
    </script>
</body>
</html>